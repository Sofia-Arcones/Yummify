<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listas de la Compra</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/custom.css">
</head>
<script th:inline="javascript">
    function updateItemStatus(checkbox) {
        var itemId = checkbox.getAttribute('data-item-id');
        var isChecked = checkbox.checked;
        fetch(`/shoppingLists/updateItemStatus?itemId=${itemId}&isPurchased=${isChecked}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                var isPurchased = data.isPurchased;
                checkbox.checked = isPurchased;

                var card = document.getElementById("card-" + itemId);
                if (card) {
                    if (isPurchased) {
                        card.classList.remove("bg-light");
                        card.classList.add("bg-success");
                    } else {
                        card.classList.remove("bg-success");
                        card.classList.add("bg-light");
                    }
                } else {
                    console.error('Elemento de la tarjeta no encontrado para el itemId:', itemId);
                }
            } else {
                console.error('Error al actualizar el estado:', data.error);
            }
        })
        .catch(error => console.error('Error en la solicitud AJAX:', error));
    }
</script>

<body class="d-flex flex-column min-vh-100">
<div class="container-fluid p-0">
    <div th:replace="~{fragments/header :: header}"></div>
</div>

<div class="container my-5">
    <h2 class="text-center text-primary mb-4">Mis Listas de la Compra</h2>
    <div class="container my-5">
        <div th:if="${success}" class="alert alert-success">
            <p th:text="${success}"></p>
        </div>
        <div th:if="${error}" class="alert alert-danger">
            <p th:text="${error}"></p>
        </div>
        <hr>

        <div th:each="shoppingList : ${shoppingListsPage.content}">
            <div class="card mb-3 bg-light">
                <div class="card-header">
                    <h5 th:text="${shoppingList.title}"></h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-info btn-sm" type="button" data-toggle="collapse"
                            th:id="'toggleDetails-' + ${shoppingList.shoppingListId}"
                            th:data-target="'#listDetails-' + ${shoppingList.shoppingListId}"
                            aria-expanded="false"
                            th:aria-controls="'listDetails-' + ${shoppingList.shoppingListId}">
                        Ver detalles
                    </button>

                    <div class="collapse" th:id="'listDetails-' + ${shoppingList.shoppingListId}">
                        <hr>
                        <ul class="list-group">
                            <div class="row">
                                <div th:each="item : ${shoppingList.listItems}" class="col-md-4 mb-4">
                                    <div class="card shadow-sm border-info border-3"
                                         th:id="'card-' + ${item.shoppingListItemId}"
                                         th:classappend="${item.isPurchased ? ' bg-success' : ' bg-light'}">
                                        <div class="card-body">
                                            <h5 class="card-title text-info"
                                                th:text="${item.ingredient.ingredientName}"></h5>
                                            <p class="card-text">
                                                <strong>Cantidad:</strong> <span
                                                    th:text="${item.quantity}">Cantidad</span><br>
                                                <strong>Unidad:</strong> <span
                                                    th:text="${item.unitOfMeasure}">Unidad</span>
                                            </p>
                                            <form th:action="@{/shoppingLists/updateItemStatus}" method="post"
                                                  id="updateItemStatusForm-${item.shoppingListItemId}">
                                                <input type="hidden" name="itemId"
                                                       th:value="${item.shoppingListItemId}"/>
                                                <input type="hidden" name="isPurchased"
                                                       th:value="${item.isPurchased ? 'false' : 'true'}"/>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="isPurchased"
                                                           th:checked="${item.isPurchased}"
                                                           id="isPurchased-${item.shoppingListItemId}"
                                                           th:data-item-id="${item.shoppingListItemId}"
                                                           onchange="updateItemStatus(this)">
                                                    <label class="form-check-label"
                                                           for="isPurchased-${item.shoppingListItemId}">
                                                        Comprado
                                                    </label>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>

